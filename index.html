<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="dynamic-title">ç¥é­”å¤¾å¨ƒå¨ƒéŠæˆ²ç”Ÿæˆç¥å™¨</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- å¼•å…¥ JSZip å’Œ FileSaver å‡½å¼åº«ç”¨æ–¼ç”Ÿæˆ ZIP æª”æ¡ˆ (åƒ…ä¾›ç”Ÿæˆå™¨ä½¿ç”¨) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <!-- å¼•å…¥ Font Awesome å‡½å¼åº« -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');
        
        /* é è¨­ç¥é­”ä¸»é¡Œé…è‰² */
        :root {
            --machine-color-primary: #2c2c54;    /* æ©Ÿè‡ºé‚Šæ¡†/æ·±è‰²å…ƒç´  (Dark Blue) */
            --machine-color-secondary: #ff6b6b;  /* æŒ‰éˆ•/è£é£¾ (Red) */
            --interface-color-bg: #4a69bd;       /* é é¢èƒŒæ™¯ (Primary Blue) */
            --interface-color-accent: #feca57;   /* æ¨™é¡Œ/å¼·èª¿è‰² (Orange) */
            --info-color-panel: #ff9ff3;         /* ç‹€æ…‹é¢æ¿ (Pink) */
            --token-panel-bg: #feca57;           /* ä»£å¹£é¢æ¿èƒŒæ™¯ */
            --score-panel-bg: #ff6b6b;           /* åˆ†æ•¸é¢æ¿èƒŒæ™¯ */
            --text-color-dark: #2c2c54;
            --claw-color: #8c8c8c;               /* çˆªå­é¡è‰² */
        }

        body {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            min-height: 100vh;
            font-family: 'Inter', 'Arial', sans-serif;
            background: var(--interface-color-bg);
            overflow-y: auto;
            display: flex;
            flex-direction: column; /* Changed to column to stack elements naturally */
            justify-content: flex-start;
            align-items: center;
        }

        .overall-container {
            width: 100%;
            max-width: 900px;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            box-sizing: border-box;
            gap: 20px;
        }

        .main-page-title { /* ç”¨æ–¼ç”Ÿæˆå™¨é é¢æœ€ä¸Šæ–¹çš„æ¨™é¡Œ */
            font-size: clamp(2rem, 5vw, 3.5rem);
            font-weight: 900;
            color: var(--interface-color-accent);
            text-shadow: 4px 4px var(--machine-color-primary);
            text-align: center;
            line-height: 1.2;
            margin-bottom: 20px;
        }

        .game-container {
            position: relative;
            width: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            gap: 20px;
        }

        .game-title { /* éŠæˆ²æ©Ÿè‡ºæœ¬èº«çš„æ¨™é¡Œ */
            font-size: clamp(2rem, 5vw, 3.5rem);
            font-weight: 900;
            color: var(--interface-color-accent);
            text-shadow: 4px 4px var(--machine-color-primary);
            text-align: center;
            line-height: 1.2;
        }

        .game-area {
            width: 100%;
            max-width: 750px;
            background: #fff;
            border: 10px solid var(--machine-color-primary);
            border-radius: 15px;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.5);
        }

        /* Claw Machine Display */
        .display-box {
            position: relative;
            height: 350px;
            background: linear-gradient(to bottom, #a0d2eb, #e4f1f7);
            border-bottom: 5px solid var(--machine-color-primary);
            overflow: hidden;
        }

        /* Claw components now directly inside display-box and moved by JS */
        /* They all share common positioning properties */
        .claw, .claw-arm, .claw-cable {
            position: absolute;
            left: 50%; /* Initial center position, will be updated by JS */
            transform: translateX(-50%); /* Visually center the element around its left position */
        }
        /* Only claw needs grab animation for top and transform */
        .claw {
            transition: transform 0.5s ease-in-out, top 0.5s ease-in-out; 
        }

        /* çˆªå­æœ¬èº« (ä¸»é«”) */
        .claw {
            width: 60px; /* çˆªå­ä¸»é«”å¯¬åº¦ */
            height: 25px; /* çˆªå­ä¸»é«”é«˜åº¦ */
            background-color: var(--claw-color);
            border: 3px solid #4d4d4d;
            border-radius: 6px; /* ç¨å¾®åœ“è§’çš„çŸ©å½¢ */
            top: 10px; /* è·é›¢é ‚éƒ¨çš„åˆå§‹ä½ç½® */
            z-index: 10;
            
            /* ç”¨æ–¼å®šä½å½å…ƒç´ çš„åŸºæº–ï¼Œé›–ç„¶ä¸å† flexï¼Œä½†ä¿ç•™ä»¥é˜²è¬ä¸€ */
            overflow: visible; /* ç¢ºä¿å½å…ƒç´ ä¸è¢«è£å‰ª */
        }

        .claw.grabbing {
            transition: top 0.5s ease-in, transform 0.1s ease-in-out; /* æŠ“å–æ™‚ä¸å†æœ‰ left éæ¸¡ */
        }

        /* çˆªå­çš„æŠ“æ‰‹éƒ¨åˆ† (å½å…ƒç´ ) */
        .claw::before,
        .claw::after {
            content: '';
            position: absolute; /* ç›¸å°æ–¼ .claw å®šä½ */
            width: 10px; /* æŠ“æ‰‹å¯¬åº¦ */
            height: 35px; /* æŠ“æ‰‹é•·åº¦ */
            background-color: var(--claw-color);
            border: 2px solid #4d4d4d;
            border-radius: 0 0 5px 5px; /* åº•éƒ¨åœ“è§’ */
            transform-origin: top center; /* æ—‹è½‰ä¸­å¿ƒåœ¨é ‚éƒ¨ */
            transition: transform 0.3s ease-in-out; /* æŠ“å–æ™‚çš„å¹³æ»‘å‹•ç•« */
        }

        .claw::before {
            left: 0; /* å·¦æŠ“æ‰‹å°é½Š .claw çš„å·¦é‚Šç·£ */
            top: 25px; /* å¾ .claw ä¸»é«”çš„åº•éƒ¨é–‹å§‹å»¶ä¼¸ */
            transform: rotate(-25deg); /* åˆå§‹å¼µé–‹ç‹€æ…‹ */
        }

        .claw::after {
            right: 0; /* å³æŠ“æ‰‹å°é½Š .claw çš„å³é‚Šç·£ */
            top: 25px; /* å¾ .claw ä¸»é«”çš„åº•éƒ¨é–‹å§‹å»¶ä¼¸ */
            transform: rotate(25deg); /* åˆå§‹å¼µé–‹ç‹€æ…‹ */
        }

        .claw.grabbing::before {
            transform: rotate(-5deg); /* æŠ“å–æ™‚é–‰åˆç‹€æ…‹ */
        }

        .claw.grabbing::after {
            transform: rotate(5deg); /* æŠ“å–æ™‚é–‰åˆç‹€æ…‹ */
        }

        .claw-arm {
            width: 5px;
            height: 10px; /* èª¿æ•´é«˜åº¦ä»¥é€£æ¥åˆ°çˆªå­ä¸»é«” */
            background-color: var(--claw-color);
            top: 0px; /* é€£æ¥åˆ°çˆªå­ä¸»é«”é ‚éƒ¨ */
            z-index: 9;
        }

        .claw-cable {
            width: 2px;
            background-color: #666;
            top: -300px; /* Cable length */
            height: 300px;
            z-index: 8;
        }
        
        /* Prize Area */
        .prize-area {
            position: absolute;
            bottom: 10px;
            left: 10px;
            right: 10px;
            height: 60px;
            display: flex;
            align-items: flex-end;
            gap: 10px;
            padding-bottom: 10px;
            z-index: 5;
        }

        .prize-item {
            width: 60px;
            height: 60px;
            border-radius: 8px;
            background: #f8f8f8;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
            flex-shrink: 0;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .prize-item:hover {
            transform: translateY(-2px);
        }

        .prize-item-content {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 2.5rem; /* For emojis */
        }
        .prize-item-content.is-img {
            width: 100%;
            height: 100%;
        }

        .controls {
            padding: 15px;
            background: var(--machine-color-primary);
            display: flex;
            justify-content: space-between; /* ä½¿æŒ‰éˆ•åˆ†æ•£å°é½Š */
            align-items: center;
            border-radius: 0 0 10px 10px;
            gap: 10px; /* ä½¿ç”¨ gap ä»£æ›¿å€‹åˆ¥æŒ‰éˆ•çš„ margin */
            flex-wrap: wrap; /* å…è¨±åœ¨å°è¢å¹•ä¸Šæ›è¡Œ */
        }

        .control-button {
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: bold;
            text-transform: uppercase;
            cursor: pointer;
            transition: background-color 0.1s, transform 0.1s, box-shadow 0.1s;
            box-shadow: 0 4px #0000004d;
            white-space: nowrap; /* é˜²æ­¢æŒ‰éˆ•æ–‡å­—æ›è¡Œ */
        }

        .control-button:active {
            transform: translateY(2px);
            box-shadow: 0 2px #0000004d;
        }
        .control-button i {
            margin-right: 5px; /* Space between icon and text */
        }
        .control-button i:last-child {
            margin-right: 0;
            margin-left: 5px; /* Space for right arrow */
        }


        #move-left, #move-right {
            background-color: var(--machine-color-secondary);
            color: white;
            border: 2px solid color-mix(in srgb, var(--machine-color-secondary) 80%, black);
            flex-grow: 1; /* è®“å·¦å³æŒ‰éˆ•å¯ä»¥ç¨å¾®ä¼¸å±• */
            /* ç§»é™¤ max-widthï¼Œè®“ flex-grow å’Œ flex-basis åœ¨éŸ¿æ‡‰å¼æ™‚æ›´å¥½åœ°é‹ä½œ */
        }
        #move-left:disabled, #move-right:disabled {
            background-color: color-mix(in srgb, var(--machine-color-secondary) 50%, white);
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        #grab-btn {
            background-color: var(--interface-color-accent);
            color: var(--text-color-dark);
            border: 2px solid color-mix(in srgb, var(--interface-color-accent) 80%, black);
            font-size: 1.1rem;
            padding: 12px 25px;
            margin: 0; /* ç§»é™¤ marginï¼Œä½¿ç”¨ controls çš„ gap */
            flex-grow: 2; /* è®“æŠ“å–æŒ‰éˆ•å¯ä»¥ä½”æ“šæ›´å¤šç©ºé–“ */
            max-width: 200px;
        }
        #grab-btn:disabled {
            background-color: color-mix(in srgb, var(--interface-color-accent) 50%, white);
            color: color-mix(in srgb, var(--text-color-dark) 50%, white);
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        /* Token and Score Panel Styling */
        .token-panel {
            background-color: var(--token-panel-bg);
            color: var(--text-color-dark);
        }
        .score-panel {
            background-color: var(--score-panel-bg);
            color: white; /* åˆ†æ•¸é€šå¸¸æ˜¯ç™½è‰²æ–‡å­—ï¼Œè·ŸèƒŒæ™¯è‰²å°æ¯” */
        }

        /* Full Screen Display for Prize Message */
        #full-screen-display {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(5px);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 100;
        }

        #full-screen-display.is-active {
            display: flex;
        }
        
        #full-screen-message {
            color: white;
            font-size: 2.5rem;
            font-weight: 900;
            text-shadow: 0 0 10px black;
            text-align: center;
        }

        .prize-grab-animation {
            animation: zoomIn 1.5s cubic-bezier(0.68, -0.55, 0.27, 1.55) forwards;
        }

        @keyframes zoomIn {
            0% { transform: scale(0.5); opacity: 0; }
            50% { transform: scale(1.2); opacity: 1; }
            100% { transform: scale(1); opacity: 1; }
        }

        /* Grabbed Prizes Area */
        .grabbed-prizes-section {
            width: 100%;
            max-width: 750px;
            background: var(--machine-color-primary);
            color: white;
            padding: 15px;
            border-radius: 15px;
            border: 5px solid var(--interface-color-accent);
        }
        
        #grabbed-prizes-list {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            min-height: 70px;
            padding: 10px 0;
            justify-content: center;
        }
        
        .grabbed-prizes-section h2 {
            font-size: 1.5rem;
            color: var(--info-color-panel);
            text-align: center;
            margin-bottom: 10px;
            text-shadow: 1px 1px 2px #000;
        }

        /* GENERATOR STYLES (æœƒè¢«ç§»é™¤æ–¼ä¸‹è¼‰ç‰ˆ) */
        .generator-toggle {
            background-color: var(--interface-color-accent);
            color: var(--text-color-dark);
            padding: 10px 15px;
            border: 3px solid var(--machine-color-primary);
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            font-size: 1.1rem;
            margin-bottom: 10px;
            transition: background-color 0.2s, transform 0.1s;
        }

        .generator-toggle:hover {
            background-color: color-mix(in srgb, var(--interface-color-accent) 80%, white);
        }

        .generator-panel {
            width: 100%;
            max-width: 750px;
            background: #fff;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
            border: 5px solid var(--machine-color-primary);
            display: none; /* Starts hidden */
            flex-direction: column;
            gap: 20px;
            margin-bottom: 20px;
        }

        .generator-panel.is-open {
            display: flex;
        }

        /* generator panel H2/H3 styles */
        .generator-panel h2 {
            text-align: center; /* è®“éŠæˆ²åƒæ•¸è¨­å®šæ¨™é¡Œç½®ä¸­ */
        }
        .config-group {
            border: 1px solid #ddd;
            padding: 15px;
            border-radius: 8px;
        }
        .config-group h3 {
            font-size: 1.25rem;
            font-weight: bold;
            color: var(--text-color-dark);
            margin-bottom: 10px;
        }
        .config-row {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
        }
        .config-item {
            display: flex;
            flex-direction: column;
            flex-grow: 1;
            min-width: 150px;
        }
        .config-item input {
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }

        /* Theme selection buttons */
        .theme-button {
            padding: 8px 12px;
            border-radius: 6px;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.1s, box-shadow 0.1s, outline 0.1s;
            outline: 2px solid transparent; /* Default outline */
        }
        .theme-button:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        .theme-button.selected-theme {
            outline: 3px solid var(--interface-color-accent); /* æ¡†é¸ç‰¹æ•ˆ */
            box-shadow: 0 0 0 2px var(--machine-color-primary); /* å¤–å±¤é™°å½± */
        }

        /* Apply Settings Button specific style */
        #apply-settings-btn {
            background-color: lightgray; /* æ·ºç°è‰² */
            color: #333; /* æ·±è‰²æ–‡å­— */
            border: 2px solid #a0a0a0; /* ç°è‰²é‚Šæ¡† */
            box-shadow: 0 4px #7a7a7a4d; /* èª¿æ•´é™°å½±é¡è‰²ä»¥é…åˆæ·ºè‰²æŒ‰éˆ• */
        }
        #apply-settings-btn:active {
            background-color: #c0c0c0; /* æŒ‰ä¸‹æ™‚æ›´æ·±çš„ç°è‰² */
            transform: translateY(2px);
            box-shadow: 0 2px #7a7a7a4d;
        }

        #prize-json-input {
            width: 100%;
            min-height: 250px;
            padding: 10px;
            border: 2px solid var(--interface-color-bg);
            border-radius: 6px;
            font-family: monospace;
            font-size: 0.9rem;
            resize: vertical;
            white-space: pre;
            overflow-wrap: normal;
            overflow-x: auto;
        }

        #download-zip-btn {
            background-color: #20bf6b; /* Green for download */
            color: white;
            padding: 12px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            transition: background-color 0.2s;
            margin-top: 10px;
        }
        #download-zip-btn:hover {
            background-color: #199c58;
        }

        .generator-message {
            margin-top: 10px;
            padding: 10px;
            border-radius: 6px;
            font-weight: bold;
            min-height: 20px;
        }

        .generator-message.success {
            background-color: #d4edda;
            color: #155724;
        }

        .generator-message.error {
            background-color: #f8d7da;
            color: #721c24;
        }

        /* å‰ç¥¥ç‰©æ¨£å¼ */
        .liyuchill-mascot {
            position: fixed;
            bottom: 20px;
            left: 20px;
            z-index: 1000;
            width: 120px; /* å°ºå¯¸æ”¾å¤§1.5å€ */
            height: 120px; /* å°ºå¯¸æ”¾å¤§1.5å€ */
            cursor: pointer;
            transition: transform 0.2s ease-in-out;
            display: none; /* é è¨­éš±è—ï¼Œåƒ…åœ¨ç”Ÿæˆå™¨é é¢é¡¯ç¤º */
        }
        .liyuchill-mascot img {
            width: 100%;
            height: 100%;
            /* filter: grayscale(100%) brightness(0.7); /* é è¨­ç°éšæš—æ·¡ - ç§»é™¤æ­¤è¡Œï¼Œè®“åœ–ç‰‡é¡¯ç¤ºæ­£å¸¸è‰² */
            transition: filter 0.5s ease-in-out;
        }

        .liyuchill-mascot:hover {
            animation: shake 0.5s cubic-bezier(.36,.07,.19,.97) both;
            transform: translate3d(0, 0, 0);
            backface-visibility: hidden;
            perspective: 1000px;
        }

        .liyuchill-mascot:hover img {
            filter: none; /* ç¢ºä¿æ‡¸åœæ™‚ç§»é™¤ä»»ä½•é è¨­æ¿¾é¡ */
            animation: neon-glow 1.5s ease-in-out infinite alternate; /* éœ“è™¹ç‡ˆå…‰å‹•ç•« */
        }

        @keyframes shake {
            10%, 90% { transform: translate3d(-1px, 0, 0); }
            20%, 80% { transform: translate3d(2px, 0, 0); }
            30%, 50%, 70% { transform: translate3d(-4px, 0, 0); }
            40%, 60% { transform: translate3d(4px, 0, 0); }
        }

        @keyframes neon-glow {
            0% {
                filter: hue-rotate(0deg) drop-shadow(0 0 5px #fff) drop-shadow(0 0 10px #f0f);
            }
            100% {
                filter: hue-rotate(360deg) drop-shadow(0 0 10px #fff) drop-shadow(0 0 20px #0ff);
            }
        }

        /* éŸ¿æ‡‰å¼èª¿æ•´ */
        @media (max-width: 640px) { /* Small screens */
            .controls {
                flex-direction: row; /* ä¿æŒæ°´å¹³æ’åˆ—ï¼Œä½†å…è¨±æ›è¡Œ */
                justify-content: center;
            }
            #move-left, #move-right, #grab-btn {
                flex-basis: auto; /* è®“å®ƒå€‘æ ¹æ“šå…§å®¹å’Œ flex-grow èª¿æ•´å¤§å° */
            }
            #grab-btn {
                order: 3; /* åœ¨å°è¢å¹•ä¸Šå°‡æŠ“å–æŒ‰éˆ•ç§»åˆ°æœ€å¾Œ */
                flex-basis: 100%; /* è®“å®ƒä½”æ»¿ä¸€è¡Œ */
                max-width: none; /* å–æ¶ˆæœ€å¤§å¯¬åº¦é™åˆ¶ */
            }
            #move-left { order: 1; }
            #move-right { order: 2; }
        }

        @media (max-width: 480px) { /* Extra small screens */
            .control-button {
                padding: 8px 12px; /* æ›´å°çš„å…§é‚Šè· */
                font-size: 0.9rem; /* æ›´å°çš„å­—é«” */
            }
            #grab-btn {
                padding: 10px 15px;
            }
        }
    </style>
</head>
<body>
    <div class="overall-container">

        <!-- ç”Ÿæˆå™¨ä¸»æ¨™é¡Œ (åƒ…åœ¨ç”Ÿæˆå™¨é é¢é¡¯ç¤ºï¼Œä¸‹è¼‰æ™‚ç§»é™¤) -->
        <h1 class="main-page-title" id="main-generator-title">
            ç¥é­”å¤¾å¨ƒå¨ƒéŠæˆ²ç”Ÿæˆç¥å™¨
        </h1>
        
        <!-- GENERATOR TOOL START (åƒ…åœ¨ç”Ÿæˆå™¨é é¢é¡¯ç¤ºï¼Œä¸‹è¼‰æ™‚ç§»é™¤) -->
        <button id="generator-toggle" class="generator-toggle"><i class="fa-solid fa-gear"></i> ç·¨è¼¯ä»‹é¢ (é»æ“Šå±•é–‹)</button>
        <div id="generator-panel" class="generator-panel">
            <h2 class="text-xl font-bold text-dark-blue-text mb-4 text-center"><i class="fa-solid fa-cog mr-2"></i>éŠæˆ²åƒæ•¸è¨­å®š</h2>

            <!-- 1. ä»‹é¢èˆ‡å¤–è§€è¨­å®š -->
            <div class="config-group">
                <h3><i class="fa-solid fa-palette mr-2"></i>ä»‹é¢èˆ‡å¤–è§€</h3>
                <div class="config-row">
                    <div class="config-item w-full">
                        <label for="game-title-input">éŠæˆ²æ¨™é¡Œ:</label>
                        <input type="text" id="game-title-input" value="å¤¾å¨ƒå¨ƒæ©ŸéŠæˆ²ç³»çµ±">
                    </div>
                    <div class="config-item w-full">
                        <label for="footer-text-input">é å°¾ç‰ˆæ¬Šæ–‡å­—:</label>
                        <input type="text" id="footer-text-input" value="Copyright Â© Liyuchiutiger Gongminshen">
                    </div>
                    <div class="config-item w-full">
                        <label class="block mb-2 font-bold">é¸æ“‡é…è‰²é¢¨æ ¼:</label>
                        <div id="theme-buttons" class="flex flex-wrap gap-2">
                            <!-- Theme buttons will be generated here by JavaScript -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- 2. éŠæˆ²æ•¸å€¼è¨­å®š -->
            <div class="config-group">
                <h3><i class="fa-solid fa-calculator mr-2"></i>éŠæˆ²æ•¸å€¼è¨­å®š</h3>
                <div class="config-row">
                    <div class="config-item">
                        <label for="initial-tokens-input">åˆå§‹ä»£å¹£æ•¸é‡:</label>
                        <input type="number" id="initial-tokens-input" min="1" step="1" value="5">
                    </div>
                    <div class="config-item">
                        <label for="grab-cost-input">æ¯æ¬¡å¤¾å–è²»ç”¨ (ä»£å¹£):</label>
                        <input type="number" id="grab-cost-input" min="1" step="1" value="1">
                    </div>
                    <div class="config-item">
                        <label for="success-rate-input">å¤¾å–æˆåŠŸç‡ (%):</label>
                        <input type="number" id="success-rate-input" min="0" max="100" step="5" value="70">
                    </div>
                </div>
            </div>

            <!-- 3. å¨ƒå¨ƒæ± è¨­å®š -->
            <div class="config-group">
                <h3><i class="fa-solid fa-box-open mr-2"></i>å¨ƒå¨ƒæ± è¨­å®š (JSON æ ¼å¼)</h3>
                <p class="text-sm text-gray-600 mb-2">
                    **asset** æ¬„ä½å¯å¡«å¯«åœ–ç‰‡ç¶²å€ (URL) æˆ–å–®ä¸€è¡¨æƒ…ç¬¦è™Ÿ/ç¬¦è™Ÿ (Emoji/Symbol)ã€‚<br>
                    **rate** å¿…é ˆæ˜¯ $0$ åˆ° $1$ ä¹‹é–“çš„å°æ•¸ã€‚ç¸½æ©Ÿç‡æœƒè‡ªå‹•æŒ‰æ¯”ä¾‹èª¿æ•´ã€‚
                </p>
                <textarea id="prize-json-input" rows="10" placeholder="[
    { &quot;name&quot;: &quot;é­”æ³•çŸ³&quot;, &quot;rate&quot;: 0.01, &quot;asset&quot;: &quot;ğŸ’&quot;, &quot;score&quot;: 500 },
    { &quot;name&quot;: &quot;è¬å¹´éˆé­‚çŸ³&quot;, &quot;rate&quot;: 0.05, &quot;asset&quot;: &quot;https://placehold.co/60x60/feca57/000000?text=é­‚&quot;, &quot;score&quot;: 100 },
    { &quot;name&quot;: &quot;é«”åŠ›å›å¾©åŠ‘&quot;, &quot;rate&quot;: 0.1, &quot;asset&quot;: &quot;ğŸ’‰&quot;, &quot;score&quot;: 50 }
]"></textarea>
            </div>

            <button id="apply-settings-btn" class="control-button">å¥—ç”¨æ‰€æœ‰è¨­å®šä¸¦é‡ç½®éŠæˆ²</button>
            <button id="download-zip-btn" class="control-button"><i class="fa-solid fa-download"></i> ä¸‹è¼‰éŠæˆ² (.zip)</button>
            <div id="generator-message" class="generator-message"></div>
        </div>
        <!-- GENERATOR TOOL END -->

        <!-- GAME SECTION START -->
        <div class="game-container">
            <h1 id="game-title" class="game-title">
                ç¥é­”å¤¾å¨ƒå¨ƒæ©Ÿ
            </h1>
            
            <!-- SCORES AND TOKENS DISPLAY -->
            <div class="w-full max-w-750px flex justify-center gap-4 text-white font-bold">
                <div class="p-2 rounded-lg shadow-md flex-1 text-center token-panel">
                    ä»£å¹£: <span id="token-display">5</span>
                </div>
                <div class="p-2 rounded-lg shadow-md flex-1 text-center score-panel">
                    åˆ†æ•¸: <span id="score-display">0</span>
                </div>
            </div>

            <div class="game-area">
                <div class="display-box">
                    <!-- Claw components are now direct children of display-box -->
                    <div id="claw-cable" class="claw-cable"></div>
                    <div id="claw-arm" class="claw-arm"></div>
                    <div id="claw" class="claw"></div> 

                    <!-- Prize Area -->
                    <div id="prize-area" class="prize-area">
                        <!-- Prizes will be generated here -->
                    </div>
                </div>

                <div class="controls">
                    <button id="move-left" class="control-button"><i class="fa-solid fa-arrow-left"></i> å‘å·¦ (A)</button>
                    <!-- æŠ“å–æŒ‰éˆ•ç§»åˆ°ä¸­é–“ï¼Œä¸¦ç§»é™¤ game-status é¡¯ç¤º -->
                    <button id="grab-btn" class="control-button" disabled>æŠ“å– (-1ä»£å¹£)</button>
                    <button id="move-right" class="control-button">å‘å³ (D) <i class="fa-solid fa-arrow-right"></i></button>
                </div>
            </div>
            
            <div class="grabbed-prizes-section">
                <h2>å·²å¤¾å–çš„å¨ƒå¨ƒ</h2>
                <div id="grabbed-prizes-list">
                    <!-- Grabbed prizes items will appear here -->
                </div>
            </div>
            
            <footer id="game-footer" class="text-center text-sm text-white/70 mt-5">
                Copyright Â© Liyuchiutiger Gongminshen
            </footer>
        </div>
        <!-- GAME SECTION END -->
    </div>

    <!-- Full Screen Display for Prize Announcement (Replaces alert()) -->
    <div id="full-screen-display">
        <div id="full-screen-message"></div>
    </div>

    <!-- å‰ç¥¥ç‰© -->
    <div id="liyuchill-mascot" class="liyuchill-mascot">
        <img src="image/LiyuChillGuy.svg" alt="LiyuChillGuy Mascot">
    </div>

    <!-- ç”Ÿæˆå™¨é é¢å°ˆå±¬ç‰ˆæ¬Š (æ”¾åœ¨ body æœ€åº•éƒ¨) -->
    <footer id="generator-copyright" class="text-center text-xs text-yellow-500 mt-10 p-2">
        Copyright Â© Liyuchiutiger Gongminshen
    </footer>

    <script>
        // --- CONFIGURATION DEFAULTS ---
        let gameConfig = {
            title: "å¤¾å¨ƒå¨ƒæ©ŸéŠæˆ²ç³»çµ±",
            footerText: "Copyright Â© Liyuchiutiger Gongminshen",
            initialTokens: 5,
            grabCost: 1,
            successRate: 70, // Percentage
            theme: "gods_and_demons"
        };
        
        let userStats = {
            tokens: 0, // Will be set to initialTokens on init
            score: 0
        };

        // Updated PRIZE_POOL with 'asset' key and examples of URL and Emoji
        let PRIZE_POOL = [
            { name: "æ°´é‘½çŸ³", rate: 0.01, asset: "ğŸ’", score: 500 },
            { name: "å…¬æ°‘å¥½ç¥", rate: 0.05, asset: "https://gongminshenliyuchiutiger.github.io/__public-useful__/image/LiyuChill.svg", score: 100 },
            { name: "é»ƒé‡‘è™", rate: 0.1, asset: "ğŸ¯", score: 50 },
            { name: "å¤§ç™¼è²¡", rate: 0.3, asset: "ğŸ’°", score: 10 },
            { name: "å¹¸é‹è‰", rate: 0.54, asset: "ğŸ€", score: 5 },
            { name: "å¿«æ¨‚é¯‰é­š", rate: 0.54, asset: "ğŸŸ", score: 5 },
        ];
        
        // --- GAME CONSTANTS ---
        let CUMULATIVE_RATES = [];
        const CLAW_SPEED = 0.5; // Percentage of display-box width per frame
        // MIN_CLAW_X å’Œ MAX_CLAW_X å°‡è¢«å‹•æ…‹è¨ˆç®—ï¼Œä»¥ç¢ºä¿çˆªå­çš„é‚Šç·£è²¼åˆé‚Šç•Œã€‚

        const gameStates = {
            IDLE: 'ç§»å‹•ä¸­...',
            GRABBING: 'æŠ“å–ä¸­...',
            RETURN: 'è¿”å›ä¸­...',
            PRIZE_ANNOUNCE: 'å…¬ä½ˆçå‹µ...',
            DISABLED: 'è«‹ç¨å€™...'
        };

        let currentGameState = gameStates.DISABLED;
        let clawX = 50; // Initial percentage position (center)
        let clawMoveDirection = 0; // -1 for left, 1 for right, 0 for idle
        let animationFrameId = null;
        let gameInitialized = false;

        // --- DOM ELEMENTS ---
        const clawElement = document.getElementById('claw');
        const clawArmElement = document.getElementById('claw-arm'); // Reference to the arm element
        const clawCableElement = document.getElementById('claw-cable'); // Reference to the cable element
        const prizeArea = document.getElementById('prize-area');
        const grabBtn = document.getElementById('grab-btn');
        const moveLeftBtn = document.getElementById('move-left');
        const moveRightBtn = document.getElementById('move-right');
        const grabbedPrizesList = document.getElementById('grabbed-prizes-list');
        const fullScreenDisplay = document.getElementById('full-screen-display');
        const fullScreenMessage = document.getElementById('full-screen-message');
        const tokenDisplay = document.getElementById('token-display');
        const scoreDisplay = document.getElementById('score-display');
        const gameTitleElement = document.getElementById('game-title'); // éŠæˆ²æ©Ÿè‡ºæœ¬èº«çš„æ¨™é¡Œ
        const dynamicTitleElement = document.getElementById('dynamic-title'); // <head> è£¡çš„ <title>
        const gameFooterElement = document.getElementById('game-footer');
        const tokenPanelElement = document.querySelector('.token-panel'); // ä»£å¹£é¢æ¿
        const scorePanelElement = document.querySelector('.score-panel'); // åˆ†æ•¸é¢æ¿
        
        // --- AUDIO SETUP ---
        let audioContext;
        let synth;

        function initAudio() {
            // ç§»é™¤é€™è£¡çš„ if (audioContext) return; æª¢æŸ¥ï¼Œä»¥ç¢ºä¿åœ¨ä¸‹è¼‰ç‰ˆä¸­éŸ³é »ç¸½èƒ½åˆå§‹åŒ–
            // if (audioContext) return; 
            try {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                
                const gainNode = audioContext.createGain();
                gainNode.gain.value = 0.1; 
                gainNode.connect(audioContext.destination);

                synth = {
                    play: (frequency, duration) => {
                        const oscillator = audioContext.createOscillator();
                        oscillator.type = 'square';
                        oscillator.frequency.setValueAtTime(frequency, audioContext.currentTime);
                        oscillator.connect(gainNode);
                        oscillator.start();
                        oscillator.stop(audioContext.currentTime + duration);
                    }
                };
            } catch (e) {
                console.warn('Audio initialization failed. If running in an iframe, this is expected.', e);
                synth = { play: () => {} };
            }
        }


        // --- CORE GAME LOGIC ---

        function updateClawPosition(deltaX) {
            const displayBox = document.querySelector('.display-box');
            if (!displayBox || !clawElement) return; // Prevent errors if elements not found

            const displayBoxWidth = displayBox.offsetWidth;
            const clawWidth = clawElement.offsetWidth; // ç²å–çˆªå­å…ƒç´ çš„åƒç´ å¯¬åº¦
            
            // è¨ˆç®—çˆªå­ä¸€åŠå¯¬åº¦ä½” display-box ç¸½å¯¬åº¦çš„ç™¾åˆ†æ¯”
            // clawX represents the center of the claw.
            // When clawX is at `halfClawWidthPercent`, the left edge of the claw is at 0%.
            // When clawX is at `100 - halfClawWidthPercent`, the right edge of the claw is at 100%.
            const halfClawWidthPercent = (clawWidth / 2 / displayBoxWidth) * 100;

            // å¦‚æœ clawWidth ç‚º 0 (ä¾‹å¦‚ï¼Œå…ƒç´ å°šæœªæ¸²æŸ“æˆ–éš±è—)ï¼Œå‰‡è¨­å®šä¸€å€‹å®‰å…¨çš„é è¨­å€¼ä»¥é¿å… NaN
            if (isNaN(halfClawWidthPercent) || halfClawWidthPercent === 0) {
                // å¦‚æœè¨ˆç®—å¤±æ•—ï¼Œæˆ‘å€‘å¯èƒ½éœ€è¦æš«æ™‚è¨­å®šä¸€å€‹å›ºå®šç¯„åœ
                // æˆ–è€…å»¶é²åŸ·è¡Œç›´åˆ°å…ƒç´ æœ‰å¯¦éš›å¯¬åº¦
                // é€™è£¡æˆ‘å€‘ç›´æ¥è¿”å›ï¼Œç­‰åˆ°ä¸‹æ¬¡ frame å†é‡æ–°è¨ˆç®—
                // console.warn("Claw width is 0 or invalid, skipping positioning update."); // ç§»é™¤éæ–¼é »ç¹çš„è­¦å‘Š
                return; 
            }

            // æ ¹æ“šçˆªå­åŠå¯¬åº¦èª¿æ•´æœ€å°å’Œæœ€å¤§ç™¾åˆ†æ¯”ä½ç½®ï¼Œä½¿çˆªå­çš„é‚Šç·£è²¼åˆ display-box çš„é‚Šç•Œ
            const minClawXAdjusted = halfClawWidthPercent;
            const maxClawXAdjusted = 100 - halfClawWidthPercent;

            clawX += deltaX;
            clawX = Math.max(minClawXAdjusted, Math.min(maxClawXAdjusted, clawX));
            
            // æ›´æ–°æ‰€æœ‰çˆªå­çµ„ä»¶çš„æ°´å¹³ä½ç½®
            clawElement.style.left = `${clawX}%`;
            clawArmElement.style.left = `${clawX}%`;
            clawCableElement.style.left = `${clawX}%`;
        }

        function gameLoop() {
            if (currentGameState === gameStates.IDLE && clawMoveDirection !== 0) {
                const moveAmount = clawMoveDirection * CLAW_SPEED; 
                updateClawPosition(moveAmount);
            }
            animationFrameId = requestAnimationFrame(gameLoop);
        }
        
        function updateStatsDisplay() {
            tokenDisplay.textContent = userStats.tokens;
            scoreDisplay.textContent = userStats.score;
            
            // æ›´æ–°æŠ“å–æŒ‰éˆ•æ–‡å­—ï¼Œé¡¯ç¤ºè²»ç”¨
            grabBtn.textContent = `æŠ“å– (-${gameConfig.grabCost} ä»£å¹£)`;

            // æ ¹æ“šä»£å¹£æ•¸é‡å•Ÿç”¨æˆ–ç¦ç”¨æŠ“å–æŒ‰éˆ•
            if (userStats.tokens < gameConfig.grabCost) {
                grabBtn.disabled = true;
            } else {
                grabBtn.disabled = currentGameState !== gameStates.IDLE;
            }
        }

        function setGameState(state) {
            currentGameState = state;
            
            const isIdle = state === gameStates.IDLE;
            moveLeftBtn.disabled = !isIdle;
            moveRightBtn.disabled = !isIdle;
            
            // æŠ“å–æŒ‰éˆ•åªæœ‰åœ¨ IDLE ç‹€æ…‹ä¸”ä»£å¹£è¶³å¤ æ™‚æ‰å•Ÿç”¨
            grabBtn.disabled = !isIdle || userStats.tokens < gameConfig.grabCost;
            
            updateStatsDisplay(); // æ›´æ–°æŒ‰éˆ•æ–‡å­—å’Œä»£å¹£åˆ†æ•¸é¡¯ç¤º
        }

        function moveClaw(direction) {
            initAudio();
            if (currentGameState !== gameStates.IDLE) return;

            if (direction === 'left') {
                clawMoveDirection = -1;
            } else if (direction === 'right') {
                clawMoveDirection = 1;
            }
        }

        function stopMove() {
            clawMoveDirection = 0;
        }

        function grabPrize() {
            initAudio();
            if (currentGameState !== gameStates.IDLE || userStats.tokens < gameConfig.grabCost) return;
            
            // Deduct cost
            userStats.tokens -= gameConfig.grabCost;
            updateStatsDisplay();

            setGameState(gameStates.GRABBING);
            synth.play(440, 0.2); // Grab sound

            // Stop horizontal movement animation
            cancelAnimationFrame(animationFrameId);
            clawMoveDirection = 0;

            // Start vertical movement animation
            clawElement.classList.add('grabbing');
            clawElement.style.top = '270px'; // Move down to prize level

            // Prize determination after a short delay (simulating physical grab)
            setTimeout(() => {
                const prize = determinePrize();
                const successRate = gameConfig.successRate / 100;
                const isSuccess = Math.random() < successRate;

                if (isSuccess) {
                    processSuccessfulGrab(prize);
                } else {
                    processFailedGrab();
                }

            }, 500); // Time to move down
        }

        function determinePrize() {
            const r = Math.random();
            const prizeIndex = CUMULATIVE_RATES.findIndex(cumulativeRate => r <= cumulativeRate);
            // Fallback for safety
            return PRIZE_POOL[prizeIndex >= 0 ? prizeIndex : PRIZE_POOL.length - 1]; 
        }

        // Helper function to check if asset is a URL or a symbol
        function isUrl(asset) {
            return asset && (asset.startsWith('http://') || asset.startsWith('https://'));
        }
        
        function processSuccessfulGrab(prize) {
            synth.play(523, 0.5); // Success sound (C5)
            setGameState(gameStates.PRIZE_ANNOUNCE);
            
            // Update score
            userStats.score += prize.score;
            updateStatsDisplay();

            // Claw returns with prize
            clawElement.style.top = '10px';
            
            // Show full screen announcement
            setTimeout(() => {
                showPrizeAnnouncement(prize.asset, prize.name, prize.score, true);
                // Claw returns to idle position
                setTimeout(resetGame, 1000); 
            }, 500);
        }

        function processFailedGrab() {
            synth.play(261, 0.5); // Fail sound (C4)
            setGameState(gameStates.RETURN);
            
            // Claw returns empty
            setTimeout(() => {
                clawElement.style.top = '10px';
                showPrizeAnnouncement('', 'æŠ“å–å¤±æ•—ï¼çå“å¾çˆªå­æºœèµ°äº†...ğŸ˜­', 0, false);
                setTimeout(resetGame, 1000); 
            }, 500);
        }

        function resetGame() {
            clawElement.classList.remove('grabbing');
            setGameState(gameStates.IDLE);
            animationFrameId = requestAnimationFrame(gameLoop);
        }
        
        // --- UTILITY FUNCTIONS ---
        
        function showPrizeAnnouncement(asset, prizeName, score, isSuccess) {
            fullScreenMessage.innerHTML = ''; // Clear existing
            
            if (isSuccess) {
                const prizeAssetContainer = document.createElement('div');
                prizeAssetContainer.className = 'w-32 h-32 mx-auto mb-4 rounded-xl prize-grab-animation flex justify-center items-center bg-white/70';
                
                if (isUrl(asset)) {
                    const prizeImage = document.createElement('img');
                    prizeImage.src = asset;
                    prizeImage.alt = prizeName;
                    prizeImage.className = 'w-full h-full object-cover rounded-xl';
                    prizeImage.onerror = () => prizeImage.src = `https://placehold.co/60x60/8c8c8c/ffffff?text=åœ–éŒ¯`;
                    prizeAssetContainer.appendChild(prizeImage);
                } else {
                    prizeAssetContainer.textContent = asset;
                    prizeAssetContainer.style.fontSize = '4rem';
                    prizeAssetContainer.style.backgroundColor = 'transparent';
                }
                
                const messageText = document.createElement('div');
                messageText.className = 'p-4 bg-green-500/90 rounded-xl shadow-2xl text-white text-3xl font-bold';
                messageText.innerHTML = `æ­å–œç²å¾—ï¼š${prizeName}ï¼<br><span class="text-xl">(ç²å¾—åˆ†æ•¸: +${score})</span>`;

                fullScreenMessage.appendChild(prizeAssetContainer);
                fullScreenMessage.appendChild(messageText);

                addPrizeToGrabbedArea(asset, prizeName);

            } else {
                const messageText = document.createElement('div');
                messageText.className = 'p-4 bg-red-500/90 rounded-xl shadow-2xl text-white text-3xl font-bold';
                messageText.textContent = prizeName; // Use the fail message directly
                fullScreenMessage.appendChild(messageText);
            }

            fullScreenDisplay.classList.add('is-active');

            const totalDisplayDuration = 2000; 

            setTimeout(() => {
                fullScreenDisplay.classList.remove('is-active');
                fullScreenMessage.innerHTML = '';
            }, totalDisplayDuration);
        }

        function addPrizeToGrabbedArea(asset, type) {
            const prizeItem = document.createElement('div');
            prizeItem.className = 'prize-item';
            prizeItem.dataset.type = type;

            const contentContainer = document.createElement('div');
            contentContainer.className = 'prize-item-content';

            if (isUrl(asset)) {
                contentContainer.classList.add('is-img');
                const img = document.createElement('img');
                img.src = asset;
                img.alt = type;
                img.onerror = () => img.src = `https://placehold.co/60x60/8c8c8c/ffffff?text=åœ–éŒ¯`; // Fallback image
                contentContainer.appendChild(img);
            } else {
                contentContainer.textContent = asset;
            }
            
            prizeItem.appendChild(contentContainer);
            grabbedPrizesList.appendChild(prizeItem);
        }

        // --- PRIZE POOL MANAGEMENT (GENERATOR CORE) ---

        function initializePrizes() {
            // Recalculate CUMULATIVE_RATES based on the current PRIZE_POOL
            const totalRate = PRIZE_POOL.reduce((sum, prize) => sum + prize.rate, 0);
            let currentCumulativeRate = 0;
            CUMULATIVE_RATES = PRIZE_POOL.map(prize => {
                currentCumulativeRate += prize.rate / totalRate;
                return currentCumulativeRate;
            });
            console.log('Prize Pool initialized. Cumulative Rates:', CUMULATIVE_RATES);
        }

        function setupPrizes() {
            // Clears and redraws the prize board
            prizeArea.innerHTML = '';
            
            // Only display a subset of prizes for visual effect on the board
            const displayCount = Math.min(PRIZE_POOL.length, 10);
            for (let i = 0; i < displayCount; i++) {
                // To show diversity, we pick randomly from the pool to display
                const prize = PRIZE_POOL[Math.floor(Math.random() * PRIZE_POOL.length)];
                
                const prizeItem = document.createElement('div');
                prizeItem.className = 'prize-item';
                prizeItem.title = `${prize.name} (æ©Ÿç‡: ${(prize.rate * 100).toFixed(2)}%, åˆ†æ•¸: ${prize.score})`;

                const contentContainer = document.createElement('div');
                contentContainer.className = 'prize-item-content';

                if (isUrl(prize.asset)) {
                    contentContainer.classList.add('is-img');
                    const img = document.createElement('img');
                    img.src = prize.asset;
                    img.alt = prize.name;
                    img.onerror = () => img.src = `https://placehold.co/60x60/8c8c8c/ffffff?text=åœ–éŒ¯`; // Fallback image
                    contentContainer.appendChild(img);
                } else {
                    contentContainer.textContent = prize.asset;
                }
                
                prizeItem.appendChild(contentContainer);


                // Add random positioning within the prize area boundaries
                const prizeAreaComputedWidth = prizeArea.offsetWidth;
                const itemWidth = 70; // prize-item width + margin (60px + 10px)
                const maxLeft = prizeAreaComputedWidth > itemWidth ? prizeAreaComputedWidth - itemWidth : 0;
                const randomLeft = Math.floor(Math.random() * maxLeft);
                
                prizeItem.style.position = 'absolute';
                prizeItem.style.left = `${randomLeft}px`;
                prizeItem.style.bottom = '10px';
                
                prizeArea.appendChild(prizeItem);
            }
        }
        
        // --- GENERATOR TOOL SETUP (åƒ…åœ¨ç”Ÿæˆå™¨é é¢å‘¼å«) ---

        const THEMES = {
            gods_and_demons: {
                'label': 'ç¥é­”ä¸»é¡Œ (è—/ç´…/é»ƒ)',
                '--machine-color-primary': '#2c2c54',
                '--machine-color-secondary': '#ff6b6b',
                '--interface-color-bg': '#4a69bd',
                '--interface-color-accent': '#feca57',
                '--info-color-panel': '#ff9ff3',
                '--token-panel-bg': '#feca57',
                '--score-panel-bg': '#ff6b6b',
                '--text-color-dark': '#2c2c54',
                '--claw-color': '#8c8c8c',
                'buttonTextColor': 'white', // Explicitly set for button preview
            },
            arcade_neon: {
                'label': 'è¡—æ©Ÿéœ“è™¹ (ç´«/ç¶ /ç²‰)',
                '--machine-color-primary': '#2d004d',
                '--machine-color-secondary': '#00ff7f',
                '--interface-color-bg': '#330066',
                '--interface-color-accent': '#ff69b4',
                '--info-color-panel': '#87ceeb',
                '--token-panel-bg': '#ff69b4',
                '--score-panel-bg': '#00ff7f',
                '--text-color-dark': '#1a0033',
                '--claw-color': '#00b894',
                'buttonTextColor': 'white',
            },
            classic_wood: {
                'label': 'ç¶“å…¸æœ¨ç´‹ (æ£•/é‡‘/ç™½)',
                '--machine-color-primary': '#5c4033',
                '--machine-color-secondary': '#c7a31f',
                '--interface-color-bg': '#8b4513',
                '--interface-color-accent': '#f0e68c',
                '--info-color-panel': '#ffffff',
                '--token-panel-bg': '#f0e68c',
                '--score-panel-bg': '#c7a31f',
                '--text-color-dark': '#333333',
                '--claw-color': '#7a675d',
                'buttonTextColor': 'white',
            },
            pastoral_forest: {
                'label': 'ç”°åœ’æ£®æ—',
                '--machine-color-primary': '#386641',
                '--machine-color-secondary': '#6a994e',
                '--interface-color-bg': '#a7c4bc',
                '--interface-color-accent': '#f4e3b2',
                '--info-color-panel': '#f0f2eb',
                '--token-panel-bg': '#d9b384',
                '--score-panel-bg': '#4d7c0f',
                '--text-color-dark': '#283618',
                '--claw-color': '#555e52',
                'buttonTextColor': '#283618', // dark text on light green
            },
            pink_bubble: {
                'label': 'ç²‰ç´…æ³¡æ³¡',
                '--machine-color-primary': '#6a0572',
                '--machine-color-secondary': '#f72585',
                '--interface-color-bg': '#ffc2d4',
                '--interface-color-accent': '#e0b8d4',
                '--info-color-panel': '#e6f7ff',
                '--token-panel-bg': '#ffe0e9',
                '--score-panel-bg': '#d9a9d2',
                '--text-color-dark': '#4a0033',
                '--claw-color': '#b87cbe',
                'buttonTextColor': '#4a0033', // dark text on light pink
            },
            blue_water_pattern: {
                'label': 'è—è‰²æ°´ç´‹',
                '--machine-color-primary': '#004d66',
                '--machine-color-secondary': '#00b8d4',
                '--interface-color-bg': '#87ceeb',
                '--interface-color-accent': '#ff6f61',
                '--info-color-panel': '#ffffff',
                '--token-panel-bg': '#ccf5ff',
                '--score-panel-bg': '#66cdaa',
                '--text-color-dark': '#00334d',
                '--claw-color': '#4a6f87',
                'buttonTextColor': '#00334d', // dark text on light blue
            },
            starlight_glitter: {
                'label': 'æ˜Ÿå…‰ç’€ç’¨',
                '--machine-color-primary': '#1a237e',
                '--machine-color-secondary': '#ffd700',
                '--interface-color-bg': '#311b92',
                '--interface-color-accent': '#c0c0c0',
                '--info-color-panel': '#ffffff',
                '--token-panel-bg': '#fffacd',
                '--score-panel-bg': '#a78bfa',
                '--text-color-dark': '#0d1440',
                '--claw-color': '#a3b1d4',
                'buttonTextColor': 'white',
            },
            dazzling_sunlight: {
                'label': 'é™½å…‰è€€çœ¼',
                '--machine-color-primary': '#ff8c00',
                '--machine-color-secondary': '#ffeb3b',
                '--interface-color-bg': '#87ceeb',
                '--interface-color-accent': '#ffffff',
                '--info-color-panel': '#ffffa0',
                '--token-panel-bg': '#fffacd',
                '--score-panel-bg': '#ffa07a',
                '--text-color-dark': '#2196f3',
                '--claw-color': '#ffb066',
                'buttonTextColor': '#2196f3', // dark text on light blue
            },
            cool_grayscale: {
                'label': 'å†·é…·ç°éš',
                '--machine-color-primary': '#343a40',
                '--machine-color-secondary': '#6c757d',
                '--interface-color-bg': '#dee2e6',
                '--interface-color-accent': '#adb5bd',
                '--info-color-panel': '#ffffff',
                '--token-panel-bg': '#e9ecef',
                '--score-panel-bg': '#495057',
                '--text-color-dark': '#212529',
                '--claw-color': '#8e949a',
                'buttonTextColor': '#212529', // dark text on light gray
            },
            vibrant_rainbow: {
                'label': 'ç¹½ç´›å½©è™¹',
                '--machine-color-primary': '#6a0dad',
                '--machine-color-secondary': '#00bcd4',
                '--interface-color-bg': '#9c27b0',
                '--interface-color-accent': '#ffeb3b',
                '--info-color-panel': '#e91e63',
                '--token-panel-bg': '#ff9800',
                '--score-panel-bg': '#4caf50',
                '--text-color-dark': '#3f51b5',
                '--claw-color': '#e0e0e0',
                'buttonTextColor': 'white',
            }
        };

        function applyTheme(themeName) {
            const theme = THEMES[themeName];
            if (!theme) return;
            const root = document.documentElement;
            for (const [key, value] of Object.entries(theme)) {
                if (key !== 'label' && key !== 'buttonTextColor') { // 'label' and 'buttonTextColor' are not CSS variables
                    root.style.setProperty(key, value);
                }
            }
        }

        function loadSettingsFromUI() {
            // Load game settings
            gameConfig.title = document.getElementById('game-title-input').value || "å¤¾å¨ƒå¨ƒæ©Ÿ";
            gameConfig.footerText = document.getElementById('footer-text-input').value || "";
            gameConfig.initialTokens = parseInt(document.getElementById('initial-tokens-input').value) || 1;
            gameConfig.grabCost = parseInt(document.getElementById('grab-cost-input').value) || 1;
            gameConfig.successRate = parseInt(document.getElementById('success-rate-input').value) || 50;
            // gameConfig.theme å·²ç¶“ç”±æŒ‰éˆ•é»æ“Šäº‹ä»¶ç›´æ¥è¨­å®šï¼Œç„¡éœ€å¾ UI è®€å–
        }

        function applySettings() {
            loadSettingsFromUI(); // Load current UI values into gameConfig

            // 1. Apply UI changes
            dynamicTitleElement.textContent = gameConfig.title; // Update browser tab title
            gameTitleElement.textContent = gameConfig.title;    // Update game title on the page
            gameFooterElement.textContent = gameConfig.footerText;
            applyTheme(gameConfig.theme);

            // 2. Reset Game Stats
            userStats.tokens = gameConfig.initialTokens;
            userStats.score = 0;
            grabbedPrizesList.innerHTML = ''; // Clear prizes

            // 3. Update Status
            setGameState(gameStates.IDLE);
        }
        
        function setupGenerator() {
            const generatorToggle = document.getElementById('generator-toggle');
            const generatorPanel = document.getElementById('generator-panel');
            const prizeJsonInput = document.getElementById('prize-json-input');
            const applySettingsBtn = document.getElementById('apply-settings-btn');
            const downloadZipBtn = document.getElementById('download-zip-btn');
            const generatorMessage = document.getElementById('generator-message');
            const mainGeneratorTitle = document.getElementById('main-generator-title');
            const themeButtonsContainer = document.getElementById('theme-buttons'); // ç²å–ä¸»é¡ŒæŒ‰éˆ•å®¹å™¨
            const generatorCopyright = document.getElementById('generator-copyright');
            const mascotElement = document.getElementById('liyuchill-mascot');

            // é¡¯ç¤ºç”Ÿæˆå™¨ç›¸é—œå…ƒç´ 
            if (generatorCopyright) generatorCopyright.style.display = 'block';
            if (mascotElement) mascotElement.style.display = 'block';

            // è¨­å®šåˆå§‹ JSON å…§å®¹ä½œç‚ºé è¨­çå“æ± 
            prizeJsonInput.value = JSON.stringify(PRIZE_POOL, null, 2);

            // ç§»é™¤èˆŠçš„ä¸‹æ‹‰å¼é¸å–® (å¦‚æœå®ƒé‚„å­˜åœ¨çš„è©±)
            const oldThemeSelector = document.getElementById('theme-selector');
            if (oldThemeSelector) oldThemeSelector.remove();

            if (themeButtonsContainer) {
                // æ¸…ç©ºç¾æœ‰çš„æŒ‰éˆ•ï¼Œä»¥é˜²é‡è¤‡ç”Ÿæˆ
                themeButtonsContainer.innerHTML = ''; 

                for (const themeKey in THEMES) {
                    const theme = THEMES[themeKey];
                    const button = document.createElement('button');
                    button.type = 'button';
                    button.className = 'theme-button p-2 rounded-md border-2 text-sm font-medium';
                    button.textContent = theme.label;
                    button.dataset.theme = themeKey;
                    // ä½¿ç”¨ä¸»é¡Œçš„é¡è‰²ä¾†é è¦½æŒ‰éˆ•æ¨£å¼
                    button.style.backgroundColor = theme['--interface-color-bg'];
                    button.style.color = theme.buttonTextColor; // ä½¿ç”¨æ–°å¢çš„ buttonTextColor
                    button.style.borderColor = theme['--machine-color-primary'];

                    button.addEventListener('click', () => {
                        gameConfig.theme = themeKey; // æ›´æ–° gameConfig
                        // è¦–è¦ºä¸Šæ¨™è¨˜é¸ä¸­çš„æŒ‰éˆ•
                        document.querySelectorAll('.theme-button').forEach(btn => btn.classList.remove('selected-theme'));
                        button.classList.add('selected-theme');
                        applyTheme(themeKey); // ç«‹å³æ‡‰ç”¨ä¸»é¡Œä»¥é è¦½
                    });
                    themeButtonsContainer.appendChild(button);
                }
                // é è¨­é¸æ“‡ç•¶å‰ gameConfig ä¸­çš„ä¸»é¡Œ
                document.querySelector(`.theme-button[data-theme="${gameConfig.theme}"]`)?.classList.add('selected-theme');
            }


            generatorToggle.addEventListener('click', () => {
                generatorPanel.classList.toggle('is-open');
                generatorToggle.innerHTML = generatorPanel.classList.contains('is-open')
                    ? '<i class="fa-solid fa-gear"></i> ç·¨è¼¯ä»‹é¢ (é»æ“Šæ”¶èµ·)'
                    : '<i class="fa-solid fa-gear"></i> ç·¨è¼¯ä»‹é¢ (é»æ“Šå±•é–‹)';
            });

            applySettingsBtn.addEventListener('click', () => {
                const jsonText = prizeJsonInput.value;
                setGameState(gameStates.DISABLED); // Disable game during update
                generatorMessage.textContent = 'è™•ç†ä¸­...';
                generatorMessage.className = 'generator-message';

                try {
                    // --- STEP 1: Process Prize Pool ---
                    const customPrizes = JSON.parse(jsonText);
                    if (!Array.isArray(customPrizes) || customPrizes.length === 0) {
                        throw new Error('çå“æ± å¿…é ˆæ˜¯ä¸€å€‹éç©ºçš„ JSON é™£åˆ—ã€‚');
                    }

                    const isValid = customPrizes.every(p =>
                        typeof p === 'object' && p !== null &&
                        typeof p.name === 'string' && p.name.trim() !== '' &&
                        typeof p.rate === 'number' && p.rate > 0 && p.rate <= 1 &&
                        typeof p.asset === 'string' && p.asset.trim() !== '' &&
                        typeof p.score === 'number' && Number.isInteger(p.score) && p.score >= 0
                    );

                    if (!isValid) {
                        throw new Error('é™£åˆ—å…§æ¯å€‹çå“å¿…é ˆåŒ…å« name (string), rate (number, 0-1), asset (string, ç¶²å€æˆ–ç¬¦è™Ÿ), å’Œ score (integer, >= 0)ã€‚');
                    }

                    // Update the global PRIZE_POOL
                    PRIZE_POOL = customPrizes;
                    initializePrizes(); // Re-calculate cumulative rates

                    // --- STEP 2: Apply General Settings ---
                    applySettings(); 

                    setupPrizes(); // Refresh the prize area display

                    generatorMessage.textContent = `ğŸ‰ æˆåŠŸå¥—ç”¨ ${PRIZE_POOL.length} å€‹çå“å’Œæ‰€æœ‰éŠæˆ²è¨­å®šï¼éŠæˆ²å·²é‡ç½®ã€‚`;
                    generatorMessage.className = 'generator-message success';
                    
                    resetGame(); // Start a new game with the new settings

                } catch (error) {
                    console.error('Generator Error:', error);
                    generatorMessage.textContent = `âŒ å¥—ç”¨å¤±æ•—: éŒ¯èª¤è¨Šæ¯: ${error.message}`;
                    generatorMessage.className = 'generator-message error';
                    setGameState(gameStates.IDLE); // Attempt to re-enable
                }
            });
            
            downloadZipBtn.addEventListener('click', downloadGameZip);


            // Set initial UI state
            document.getElementById('game-title-input').value = gameConfig.title;
            document.getElementById('footer-text-input').value = gameConfig.footerText;
            document.getElementById('initial-tokens-input').value = gameConfig.initialTokens;
            document.getElementById('grab-cost-input').value = gameConfig.grabCost;
            document.getElementById('success-rate-input').value = gameConfig.successRate;
            // document.getElementById('theme-selector').value = gameConfig.theme; // èˆŠçš„ä¸‹æ‹‰é¸å–®å·²ç§»é™¤
        }

        // --- ZIP DOWNLOAD FUNCTIONALITY ---

        function downloadGameZip() {
            if (typeof JSZip === 'undefined' || typeof saveAs === 'undefined') {
                document.getElementById('generator-message').textContent = 'ZIP ä¸‹è¼‰å‡½å¼åº«å°šæœªè¼‰å…¥ã€‚è«‹ç¨å¾Œå†è©¦ã€‚';
                document.getElementById('generator-message').className = 'generator-message error';
                return;
            }

            // 1. å–å¾—ç•¶å‰ HTML å…§å®¹çš„æ‹·è²
            const originalHtml = document.documentElement.outerHTML;
            const parser = new DOMParser();
            const doc = parser.parseFromString(originalHtml, 'text/html');

            // 2. ç§»é™¤ç”Ÿæˆå™¨ç›¸é—œçš„ HTML å…ƒç´ 
            const mainGeneratorTitle = doc.getElementById('main-generator-title');
            if (mainGeneratorTitle) mainGeneratorTitle.remove();

            const generatorToggleButton = doc.getElementById('generator-toggle');
            if (generatorToggleButton) generatorToggleButton.remove();

            const generatorPanel = doc.getElementById('generator-panel');
            if (generatorPanel) generatorPanel.remove();

            const generatorCopyright = doc.getElementById('generator-copyright');
            if (generatorCopyright) generatorCopyright.remove();
            
            const mascotElement = doc.getElementById('liyuchill-mascot');
            if (mascotElement) mascotElement.remove();


            // 3. ç§»é™¤ JSZip å’Œ FileSaver å‡½å¼åº«çš„ script æ¨™ç±¤ (å› ç‚ºä¸‹è¼‰çš„éŠæˆ²ä¸éœ€è¦ç”Ÿæˆå™¨åŠŸèƒ½)
            const jszipScript = doc.querySelector('script[src*="jszip"]');
            if (jszipScript) jszipScript.remove();
            const fileSaverScript = doc.querySelector('script[src*="FileSaver"]');
            if (fileSaverScript) fileSaverScript.remove();
            // ç§»é™¤ Font Awesome é€£çµï¼Œå› ç‚ºå®ƒåƒ…ç”¨æ–¼ç”Ÿæˆå™¨é é¢ï¼Œå¦‚æœéœ€è¦é›¢ç·š Font Awesomeï¼Œéœ€è¦å°‡å…¶ä¸‹è¼‰åˆ°æœ¬åœ°
            const fontAwesomeLink = doc.querySelector('link[href*="font-awesome"]');
            if (fontAwesomeLink) fontAwesomeLink.remove();


            // 4. ä¿®æ”¹ <title> æ¨™ç±¤ï¼Œä½¿å…¶é¡¯ç¤ºéŠæˆ²æ¨™é¡Œè€Œä¸æ˜¯ç”Ÿæˆå™¨æ¨™é¡Œ
            const headTitle = doc.getElementById('dynamic-title');
            if (headTitle) {
                // ä½¿ç”¨å¾ gameConfig ç²å–çš„éŠæˆ²æ¨™é¡Œ
                const tempGameConfig = JSON.parse(JSON.stringify(gameConfig)); // è¤‡è£½ä¸€ä»½ï¼Œé¿å…ç›´æ¥ä¿®æ”¹
                // å¾ HTML Input ç²å–ç•¶å‰è¨­å®šï¼Œå› ç‚º gameConfig å¯èƒ½ä¸æ˜¯æœ€æ–°ç‹€æ…‹
                const gameTitleInput = document.getElementById('game-title-input');
                if (gameTitleInput) {
                    tempGameConfig.title = gameTitleInput.value;
                }
                headTitle.textContent = tempGameConfig.title;
            }

            // 5. ç¢ºä¿ downloaded index.html çš„ JS ä¸å†å‘¼å« setupGenerator()
            const mainScript = doc.querySelector('script:not([src])'); // ç²å–å…§è¯ script
            if (mainScript) {
                let scriptContent = mainScript.textContent;
                // å°‡ setupGenerator() çš„å‘¼å«è¨»é‡‹æ‰
                scriptContent = scriptContent.replace('setupGenerator();', '// setupGenerator(); // Generator removed for download');
                // ä¸¦ç§»é™¤ `initAudio()` å¾Œé¢çš„ `if (audioContext) return;` æª¢æŸ¥ï¼Œç¢ºä¿éŸ³é »ç¸½èƒ½åˆå§‹åŒ–
                scriptContent = scriptContent.replace('if (audioContext) return;', '');
                mainScript.textContent = scriptContent;
            }


            const zip = new JSZip();

            // 6. å°‡ä¿®æ”¹å¾Œçš„ HTML å…§å®¹åŠ å…¥ ZIP
            zip.file("index.html", `<!DOCTYPE html>\n` + doc.documentElement.outerHTML);

            // 7. åŠ å…¥æœ¬åœ°åœ–ç‰‡è³‡æºèªªæ˜ (æ­¤éƒ¨åˆ†å·²ç§»é™¤ï¼Œå› ç‚ºæ‚¨è¦æ±‚ä¸åŒ…å« README)
            // zip.file("assets/README.txt", instructions); // ç§»é™¤æ­¤è¡Œ
            zip.folder("assets").folder("items"); // å»ºç«‹è³‡æ–™å¤¾çµæ§‹
            zip.folder("image"); // ç‚ºäº†ç¢ºä¿ LiyuChillGuy.svg çš„è·¯å¾‘çµæ§‹ï¼Œå³ä½¿æª”æ¡ˆä¸æœƒåœ¨ä¸‹è¼‰ç‰ˆä¸­è¢«ä½¿ç”¨ï¼Œä¹Ÿå»ºç«‹è³‡æ–™å¤¾

            // 8. ç”Ÿæˆä¸¦å„²å­˜ ZIP æª”æ¡ˆ
            zip.generateAsync({type:"blob"})
            .then(function(content) {
                saveAs(content, "ClawMachine_Game.zip");
                document.getElementById('generator-message').textContent = 'âœ… ZIP æª”æ¡ˆå·²ç”Ÿæˆä¸¦é–‹å§‹ä¸‹è¼‰ï¼';
                document.getElementById('generator-message').className = 'generator-message success';
            })
            .catch(error => {
                console.error("ZIP Generation Error:", error);
                document.getElementById('generator-message').textContent = 'âŒ ZIP æª”æ¡ˆç”Ÿæˆå¤±æ•—ï¼';
                document.getElementById('generator-message').className = 'generator-message error';
            });
        }
        
        // --- EVENT LISTENERS AND INITIALIZATION ---
        
        document.addEventListener('keydown', (e) => {
            initAudio(); // ç¢ºä¿éŸ³è¨Šä¸Šä¸‹æ–‡åœ¨é¦–æ¬¡ç”¨æˆ¶äº¤äº’æ™‚è¢«åˆå§‹åŒ–

            if (currentGameState !== gameStates.IDLE) return; 

            if (e.key === 'ArrowLeft' || e.key === 'a' || e.key === 'A') {
                moveClaw('left');
            } else if (e.key === 'ArrowRight' || e.key === 'd' || e.key === 'D') {
                moveClaw('right');
            } else if ((e.key === ' ' || e.key === 'Enter') && !grabBtn.disabled) {
                e.preventDefault();
                grabPrize();
            }
        });

        document.addEventListener('keyup', (e) => {
            if (currentGameState !== gameStates.IDLE) return; 

            if (e.key === 'ArrowLeft' || e.key === 'a' || e.key === 'A' ||
                e.key === 'ArrowRight' || e.key === 'd' || e.key === 'D') {
                stopMove();
            }
        });

        moveLeftBtn.addEventListener('mousedown', () => moveClaw('left'));
        moveRightBtn.addEventListener('mousedown', () => moveClaw('right'));
        moveLeftBtn.addEventListener('mouseup', stopMove);
        moveRightBtn.addEventListener('mouseup', stopMove);
        // Ensure touch events use preventDefault to avoid strange scroll behavior on mobile
        moveLeftBtn.addEventListener('touchstart', (e) => { e.preventDefault(); moveClaw('left'); });
        moveRightBtn.addEventListener('touchstart', (e) => { e.preventDefault(); moveClaw('right'); });
        moveLeftBtn.addEventListener('touchend', stopMove);
        moveRightBtn.addEventListener('touchend', stopMove);

        grabBtn.addEventListener('click', grabPrize);

        function startGame() {
            if (gameInitialized) return;
            initializePrizes();
            
            // åªæœ‰ç•¶ generatorToggle å­˜åœ¨æ™‚æ‰åŸ·è¡Œ setupGenerator
            // é€™ç¢ºä¿äº†ä¸‹è¼‰çš„éŠæˆ²ä¸æœƒå‘¼å«ä¸å­˜åœ¨çš„å…ƒç´ 
            if (document.getElementById('generator-toggle')) {
                setupGenerator();
            } else {
                // å¦‚æœæ²’æœ‰ç”Ÿæˆå™¨ï¼Œå‰‡ç›´æ¥å¾ gameConfig é è¨­å€¼é–‹å§‹éŠæˆ²
                // æ³¨æ„ï¼šä¸‹è¼‰ç‰ˆæœƒç›´æ¥ä½¿ç”¨å…§åµŒåœ¨ JS ä¸­çš„ gameConfig å’Œ PRIZE_POOL
                // ä¸¦ä¸”æœƒå°‡ `setupGenerator()` çš„å‘¼å«è¨»é‡‹æ‰ã€‚
            }

            applySettings(); // Apply initial settings and set tokens/score
            setupPrizes();
            setGameState(gameStates.IDLE);
            animationFrameId = requestAnimationFrame(gameLoop);
            gameInitialized = true;
        }

        window.onload = startGame;
        window.addEventListener('resize', () => {
            setupPrizes(); // Redraw prizes on resize to fix positioning
            // é‡æ–°è¨ˆç®—çˆªå­ä½ç½®ï¼Œä»¥ç¢ºä¿éŸ¿æ‡‰å¼èª¿æ•´å¾Œé‚Šç•Œæ­£ç¢º
            updateClawPosition(0); 
        });
    </script>
</body>
</html>